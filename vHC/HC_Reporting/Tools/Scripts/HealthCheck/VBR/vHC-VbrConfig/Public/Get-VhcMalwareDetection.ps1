#Requires -Version 5.1

function Get-VhcMalwareDetection {
    <#
    .Synopsis
        Collects malware detection settings and event data.
        Gated on VBR v12+.
        Exports _malware_settings.csv, _malware_infectedobject.csv,
                _malware_events.csv, _malware_exclusions.csv.
        Source: Get-VBRConfig.ps1 lines 1662-1672.
    .Parameter VBRVersion
        Major VBR version integer. Function is a no-op for versions below 12.
    #>
    [CmdletBinding()]
    param(
        [Parameter(Mandatory = $false)]
        [int]$VBRVersion = 0
    )

    if ($VBRVersion -lt 12) {
        Write-LogFile "VBR Version ($VBRVersion) does not support Malware Detection - skipping"
        return
    }

    $message = "Collecting malware detection info..."
    Write-LogFile $message

    try {
        Get-VBRMalwareDetectionOptions   | Export-VhcCsv -FileName '_malware_settings.csv'
        Get-VBRMalwareDetectionObject    | Export-VhcCsv -FileName '_malware_infectedobject.csv'
        Get-VBRMalwareDetectionEvent     | Export-VhcCsv -FileName '_malware_events.csv'
        Get-VBRMalwareDetectionExclusion | Export-VhcCsv -FileName '_malware_exclusions.csv'
        Write-LogFile ($message + "DONE")
    }
    catch {
        Write-LogFile ($message + "FAILED!")
        Write-LogFile "Failed on Malware Detection: $($_.Exception.Message)" -LogLevel "ERROR"
    }
}
